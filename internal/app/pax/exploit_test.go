package pax

import (
	"crypto/aes"
	"encoding/base64"
	"io/ioutil"
	"net/http"
	"net/url"
	"testing"

	"github.com/stretchr/testify/assert"

	"github.com/stretchr/testify/require"
)

func Test_DecryptViaQuerystring(t *testing.T) {

	key := []byte("1234567890123456")
	secret := []byte("this an example secret")

	cipherText, err := encrypt(secret, key)
	require.NoError(t, err)

	encodedCipherText := base64.StdEncoding.EncodeToString(cipherText)

	sample := url.QueryEscape(encodedCipherText)

	ts := startVulnerableServer(key)
	defer ts.Close()

	result, err := Decrypt(ts.URL+"?enc="+sample, sample, &ExploitOptions{
		BlockSize: aes.BlockSize,
		Encoding:  EncodingBase64URL,
	})
	require.NoError(t, err)

	assert.Equal(t, secret, result)
}

func Test_DecryptViaCookie(t *testing.T) {

	key := []byte("1234567890123456")
	secret := []byte("this an example secret")

	cipherText, err := encrypt(secret, key)
	require.NoError(t, err)

	encodedCipherText := base64.StdEncoding.EncodeToString(cipherText)

	ts := startVulnerableServer(key)
	defer ts.Close()

	result, err := Decrypt(ts.URL, encodedCipherText, &ExploitOptions{
		BlockSize: aes.BlockSize,
		Cookies:   "ENC=" + encodedCipherText,
		Encoding:  EncodingBase64URL,
	})
	require.NoError(t, err)

	assert.Equal(t, secret, result)
}

func Test_EncryptViaQuerystring(t *testing.T) {

	key := []byte("1234567890123456")
	secret := []byte("this an example secret")
	plaintext := "hello!"

	cipherText, err := encrypt(secret, key)
	require.NoError(t, err)

	encodedCipherText := base64.StdEncoding.EncodeToString(cipherText)

	sample := url.QueryEscape(encodedCipherText)

	ts := startVulnerableServer(key)
	defer ts.Close()

	result, err := Encrypt(ts.URL+"?enc="+sample, sample, &ExploitOptions{
		BlockSize: aes.BlockSize,
		PlainText: plaintext,
		Encoding:  EncodingBase64URL,
	})
	require.NoError(t, err)

	req, err := http.NewRequest(http.MethodGet, ts.URL+"?enc="+string(result), nil)
	require.NoError(t, err)

	resp, err := http.DefaultClient.Do(req)
	require.NoError(t, err)
	defer resp.Body.Close()

	require.Equal(t, http.StatusOK, resp.StatusCode)

	enc, err := ioutil.ReadAll(resp.Body)
	require.NoError(t, err)

	assert.Equal(t, plaintext, string(enc))
}
