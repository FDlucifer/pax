package pax

import (
	"crypto/aes"
	"encoding/base64"
	"net/url"
	"testing"

	"github.com/stretchr/testify/assert"

	"github.com/stretchr/testify/require"
)

func Test_ExploitURL(t *testing.T) {

	key := []byte("1234567890123456")
	secret := []byte("this an example secret")

	cipherText, err := encrypt(secret, key)
	require.NoError(t, err)

	encodedCipherText := base64.StdEncoding.EncodeToString(cipherText)

	sample := url.QueryEscape(encodedCipherText)

	ts := startVulnerableServer(key)
	defer ts.Close()

	result, err := Exploit(ts.URL+"?enc="+sample, sample, aes.BlockSize)
	require.NoError(t, err)

	assert.Equal(t, secret, result)
}
